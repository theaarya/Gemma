<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diamond Marketplace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f7fa;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        
        .diamond-section-header {
            background: linear-gradient(90deg, #6633cc 0%, #4e78ff 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .diamond-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .diamond-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .diamond-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .diamond-card-header {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            background: #fcfcff;
        }
        
        .diamond-icon {
            background: #f0f4ff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: #4e78ff;
            flex-shrink: 0;
        }
        
        .diamond-icon i {
            font-size: 16px;
        }
        
        .diamond-title {
            line-height: 1.2;
        }
        
        .diamond-carat {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        
        .diamond-shape {
            font-size: 12px;
            color: #666;
        }
        
        .diamond-specs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            padding: 10px;
            gap: 8px;
            flex-grow: 1;
            font-size: 13px;
        }
        
        .diamond-spec {
            display: flex;
            flex-direction: column;
        }
        
        .spec-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 2px;
        }
        
        .spec-value {
            font-weight: 500;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .diamond-price {
            background: #f0f4ff;
            padding: 8px 12px;
            text-align: right;
            border-top: 1px solid #eee;
        }
        
        .price-value {
            font-size: 16px;
            font-weight: 600;
            color: #4e78ff;
        }
        
       
        .chat-section {
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            overflow: hidden;
            padding: 20px;
        }
        
        .chat-header {
            background: linear-gradient(90deg, #6633cc 0%, #4e78ff 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #f9fafc;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 8px;
            max-width: 90%;
        }
        
        .user-message {
            background: #e2e8fd;
            color: #333;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .bot-message {
            background: white;
            color: #333;
            border: 1px solid #eee;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex-grow: 1;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .chat-input:focus {
            border-color: #4e78ff;
        }
        
        .send-button {
            background: linear-gradient(90deg, #6633cc 0%, #4e78ff 100%);
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .send-button:hover {
            opacity: 0.9;
        }
        
        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        #dynamic-results {
            margin-top: 20px;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4e78ff;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
       
        .json-data {
            display: none;
        }
        
        
        .expert-analysis-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            padding: 15px 20px;
            margin-top: 15px;
            margin-bottom: 25px;
            border-left: 4px solid #4e78ff;
        }
        
        .expert-analysis-header {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #4e78ff;
            display: flex;
            align-items: center;
        }
        
        .expert-analysis-header i {
            margin-right: 8px;
        }
        
        .expert-analysis-content {
            font-size: 14px;
            line-height: 1.5;
            color: #444;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .diamond-results {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            }
            
            .diamond-icon {
                width: 30px;
                height: 30px;
            }
            
            .diamond-icon i {
                font-size: 14px;
            }
            
            .diamond-carat {
                font-size: 13px;
            }
            
            .price-value {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="diamond-section-header">
            Diamond Chatbot
        </div>
        
        <!-- Chat Section -->
        <div class="chat-section">
            <div class="chat-header">
                <i class="fas fa-robot"></i> Diamond Assistant
            </div>
            
            <div class="chat-messages" id="chat-messages">
                <div class="message bot-message">
                    Hello! I'm your diamond assistant. How can I help you find the perfect diamond today?
                </div>
            </div>
            
            <div class="loading-spinner" id="loading-spinner">
                <div class="spinner"></div>
            </div>
            
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chat-input" placeholder="Ask about diamonds (e.g., 'Show me 1 carat round diamonds')">
                <button class="send-button" id="send-button">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
        </div>
        
        <!-- Dynamic Results Container -->
        <div id="dynamic-results"></div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const loadingSpinner = document.getElementById('loading-spinner');
    const dynamicResults = document.getElementById('dynamic-results');
    let userStyle = ''; // Store user's diamond style preference



function selectStyle(style) {
  userStyle = style;
  document.getElementById('stylePopup').style.display = 'none';
  
  // Process any pending query
  const pendingQuery = localStorage.getItem('pendingQuery');
  if (pendingQuery) {
    localStorage.removeItem('pendingQuery');
    const fullQuery = `${pendingQuery} ${style}`;
    // Correct parameter order: message text first, then true for a user message
    addMessage(`Style preference: ${style}`, true);
    
    // Send to backend
    fetch('/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: fullQuery })
    })
    .then(response => response.json())
    .then(data => {
      addMessage(data.response, false);
    })
    .catch(error => {
      console.error('Error:', error);
      addMessage('Sorry, there was an error processing your request.', false);
    });
  }
}

    // Track if we're waiting for style selection
    let awaitingStyleSelection = false;
    let previousQuery = '';
    
    // Function to add a message to the chat
    function addMessage(text, isUser) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        messageDiv.classList.add(isUser ? 'user-message' : 'bot-message');
        
        // Process the message to hide diamond-data JSON and extract expert analysis
        let processedText = text;
        const diamondDataRegex = /<diamond-data>([\s\S]*?)<\/diamond-data>/;
        const diamondDataMatch = text.match(diamondDataRegex);
        
        // Remove expert analysis from chat message
        const expertAnalysisRegex = /<expert-analysis>([\s\S]*?)<\/expert-analysis>/;
        const expertAnalysisMatch = text.match(expertAnalysisRegex);
        if (expertAnalysisMatch) {
            processedText = processedText.replace(expertAnalysisRegex, '');
        }
        
        if (diamondDataMatch) {
            // Replace the JSON with a hidden div
            processedText = processedText.replace(diamondDataRegex, '<div class="json-data">$1</div>');
        }
        
        messageDiv.innerHTML = processedText;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Function to send a message to the server
    async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;
        
        // Add user message to chat
        addMessage(message, true);
        
        // Clear input
        chatInput.value = '';
        
        // If we're awaiting style selection, prepend the previous query
        let fullMessage = message;
        if (awaitingStyleSelection) {
            fullMessage = previousQuery + " " + message;
            awaitingStyleSelection = false;
        }
        
        // Disable input and show loading spinner
        chatInput.disabled = true;
        sendButton.disabled = true;
        loadingSpinner.style.display = 'block';
        
        try {
            // Send message to server
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: fullMessage }),
            });
            
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            const data = await response.json();
            
            // Check if we need a style selection
            if (data.needs_style) {
                awaitingStyleSelection = true;
                previousQuery = message;
                
                // Only add a bot message if there is one
                if (data.response) {
                    addMessage(data.response, false);
                }
                
                // Re-enable input for style selection
                chatInput.disabled = false;
                sendButton.disabled = false;
                loadingSpinner.style.display = 'none';
                chatInput.focus();
                chatInput.placeholder = "Type 'lab-grown' or 'natural'";
                return;
            }

            
            // Reset placeholder if not awaiting style
            chatInput.placeholder = "Ask about diamonds (e.g., 'Show me 1 carat round diamonds')";
            
            // Add bot response to chat
            addMessage(data.response, false);
            
            // Check if the response contains diamond data
            const diamondDataRegex = /<diamond-data>([\s\S]*?)<\/diamond-data>/;
            const diamondDataMatch = data.response.match(diamondDataRegex);
            
            // Check for expert analysis
            const expertAnalysisRegex = /<expert-analysis>([\s\S]*?)<\/expert-analysis>/;
            const expertAnalysisMatch = data.response.match(expertAnalysisRegex);
            let expertAnalysis = expertAnalysisMatch ? expertAnalysisMatch[1] : null;
            
            if (diamondDataMatch && diamondDataMatch[1]) {
                try {
                    const diamondData = JSON.parse(diamondDataMatch[1]);
                    // Clear any existing dynamic results
                    dynamicResults.innerHTML = '';
                    
                    // Create a header
                    const resultsHeader = document.createElement('div');
                    resultsHeader.className = 'diamond-section-header';
                    resultsHeader.textContent = `Search Results (${diamondData.length} diamonds)`;
                    dynamicResults.appendChild(resultsHeader);
                    
                    // Add expert analysis section if available
                    if (expertAnalysis) {
                        const expertSection = document.createElement('div');
                        expertSection.className = 'expert-analysis-section';
                        
                        const expertHeader = document.createElement('div');
                        expertHeader.className = 'expert-analysis-header';
                        expertHeader.innerHTML = '<i class="fas fa-gem"></i> Expert Recommendation';
                        
                        const expertContent = document.createElement('div');
                        expertContent.className = 'expert-analysis-content';
                        expertContent.textContent = expertAnalysis;
                        
                        expertSection.appendChild(expertHeader);
                        expertSection.appendChild(expertContent);
                        dynamicResults.appendChild(expertSection);
                    }
                    
                    // Create a grid for the results
                    const resultsGrid = document.createElement('div');
                    resultsGrid.className = 'diamond-results';
                    
                    // Add cards for each diamond
                    diamondData.forEach(diamond => {
                        const card = createDiamondCard(diamond);
                        resultsGrid.appendChild(card);
                    });
                    
                    dynamicResults.appendChild(resultsGrid);
                    
                    // Scroll to the results
                    dynamicResults.scrollIntoView({ behavior: 'smooth' });
                } catch (e) {
                    console.error('Error parsing diamond data:', e);
                }
            }
            
        } catch (error) {
            console.error('Error:', error);
            addMessage('Sorry, I encountered an error processing your request. Please try again.', false);
        } finally {
            // Re-enable input and hide loading spinner
            chatInput.disabled = false;
            sendButton.disabled = false;
            loadingSpinner.style.display = 'none';
            chatInput.focus();
        }
    }
    
    // Function to create a diamond card element
    function createDiamondCard(diamond) {
        const card = document.createElement('div');
        card.className = 'diamond-card';
        
        const cardHeader = document.createElement('div');
        cardHeader.className = 'diamond-card-header';
        
        const iconDiv = document.createElement('div');
        iconDiv.className = 'diamond-icon';
        iconDiv.innerHTML = '<i class="fas fa-gem"></i>';
        
        const titleDiv = document.createElement('div');
        titleDiv.className = 'diamond-title';
        
        const caratDiv = document.createElement('div');
        caratDiv.className = 'diamond-carat';
        caratDiv.textContent = `${diamond.Carat} Carat`;
        
        const shapeDiv = document.createElement('div');
        shapeDiv.className = 'diamond-shape';
        shapeDiv.textContent = diamond.Shape;
        
        titleDiv.appendChild(caratDiv);
        titleDiv.appendChild(shapeDiv);
        
        cardHeader.appendChild(iconDiv);
        cardHeader.appendChild(titleDiv);
        
        const specsDiv = document.createElement('div');
        specsDiv.className = 'diamond-specs';
        
        // Add specs
        const specs = [
            { label: 'Clarity', value: diamond.Clarity },
            { label: 'Color', value: diamond.Color },
            { label: 'Cut', value: diamond.Cut },
            { label: 'Polish', value: diamond.Polish },
            { label: 'Symmetry', value: diamond.Symmetry },
            { label: 'Style', value: diamond.Style }
        ];
        
        specs.forEach(spec => {
            const specDiv = document.createElement('div');
            specDiv.className = 'diamond-spec';
            
            const labelDiv = document.createElement('div');
            labelDiv.className = 'spec-label';
            labelDiv.textContent = spec.label;
            
            const valueDiv = document.createElement('div');
            valueDiv.className = 'spec-value';
            valueDiv.textContent = spec.value || 'N/A';
            
            specDiv.appendChild(labelDiv);
            specDiv.appendChild(valueDiv);
            specsDiv.appendChild(specDiv);
        });
        
        const priceDiv = document.createElement('div');
        priceDiv.className = 'diamond-price';
        
        const priceValueDiv = document.createElement('div');
        priceValueDiv.className = 'price-value';
        
        // Format the price with commas and dollar sign
        let formattedPrice;
        try {
            formattedPrice = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 0
            }).format(diamond.Price);
        } catch (e) {
            formattedPrice = `$${diamond.Price}`;
        }
        
        priceValueDiv.textContent = formattedPrice;
        
        priceDiv.appendChild(priceValueDiv);
        
        card.appendChild(cardHeader);
        card.appendChild(specsDiv);
        card.appendChild(priceDiv);
        
        return card;
    }
    
    // Add event listeners
    sendButton.addEventListener('click', sendMessage);
    
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    // Focus the input field when the page loads
    chatInput.focus();
});
    </script>

<!-- Add this to your HTML file -->
<div id="stylePopup" class="popup-container" style="display: none;">
    <div class="popup-content">
      <h3>Diamond Style Preference</h3>
      <p>Would you prefer a lab-grown or natural diamond?</p>
      <div class="popup-buttons">
        <button onclick="selectStyle('labgrown')">Lab-Grown</button>
        <button onclick="selectStyle('natural')">Natural</button>
      </div>
      <p class="popup-info">Lab-grown diamonds are eco-friendly and more affordable, while natural diamonds are mined from the earth and traditionally valued.</p>
    </div>
  </div>
  
  <style>
  .popup-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  
  .popup-content {
    background-color: white;
    padding: 2em;
    border-radius: 8px;
    max-width: 500px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  
  .popup-buttons {
    display: flex;
    justify-content: center;
    gap: 1em;
    margin: 1.5em 0;
  }
  
  .popup-buttons button {
    padding: 0.8em 1.5em;
    border: none;
    border-radius: 4px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .popup-buttons button:first-child {
    background-color: #4CAF50;
    color: white;
  }
  
  .popup-buttons button:last-child {
    background-color: #2196F3;
    color: white;
  }
  
  .popup-info {
    font-size: 0.9em;
    color: #666;
  }
  </style>
</body>
</html>
